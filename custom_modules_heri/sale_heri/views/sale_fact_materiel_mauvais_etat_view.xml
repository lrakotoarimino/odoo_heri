<?xml version="1.0" encoding="UTF-8"?>
<odoo>
	<data>
		<!-- Debut demande de retour de materiels par les entrepreneurs form -->
		<record model="ir.ui.view" id="demande_retour_materiel_form_view">
			<field name="name">Demande de retour de materiels par l'entrepreneur</field>
			<field name="model">sale.order</field>
			<field name="mode">primary</field>
			<field name="inherit_id" ref="sale_order_form_view_advanced"/>
			<field name="arch" type="xml">
				<xpath expr="//field[@name='partner_id']" position="before">
					<field 
					    name="kiosque_id" domain="[('is_kiosque', '=', True)]" 
					    attrs="{'required': [('facturation_type', '=', 'facturation_mat_mauvais_etat')]}"/>
				</xpath>
				<xpath expr="//field[@name='partner_id']" position="after">
					<field 	name="facturation_type" invisible="1"/>
					<field 	name="location_id" attrs="{'required': [('facturation_type', '=', 'facturation_mat_mauvais_etat')]}" string="Magasin de destination *"/>
				</xpath>
				<xpath expr="//field[@name='state']" position="replace">
					<field name="state"
							widget="statusbar" 
					    	statusbar_visible="draft,controle_technicien"/>
				</xpath>
				<xpath expr="//field[@name='order_line']/tree//field[@name='product_uom_qty']" position="after">
					<field name="qte_detenu_par_kiosque"/>
				</xpath>
				<xpath expr="//button[@name='%(sale.action_view_sale_advance_payment_inv)d'][1]" position="attributes">
					<attribute name="invisible">1</attribute>
		    		<attribute name="attrs"></attribute>
				</xpath>
				<xpath expr="//button[@name='action_view_invoice']" position="attributes">
		    		<attribute name="groups">purchase_heri.group_finance_heri</attribute>
				</xpath>
				
				<!-- bouton pour le workflow demande de retour de materiel -->
				<xpath expr="//field[@name='state']" position="before">
					<button 
			      	    string="Contrôle matériel" 
			      	    name="action_controle_technicien"
			      	    class="oe_highlight" 
			      	    attrs="{'invisible': [('state', '!=', 'draft')]}"
			      	    groups="purchase_heri.group_call_center_heri"
			      	 />
					<button 
			      	    string="Bon état" 
			      	    name="action_bon_etat"
			      	    class="oe_highlight" 
			      	    attrs="{'invisible': [('state', '!=', 'controle_technicien')]}"
			      	    groups="purchase_heri.group_technicien_heri"
			      	 />
			      	 <button 
			      	    string="Mauvais état" 
			      	    name="action_mauvais_etat"
			      	    class="oe_highlight" 
			      	    attrs="{'invisible': [('state', '!=', 'controle_technicien')]}"
			      	    groups="purchase_heri.group_technicien_heri"
			      	 />
					<button 
			      	    string="A revoir par le call center" 
			      	    name="action_revoir_call"
			      	    attrs="{'invisible': [('state', '!=', 'controle_technicien')]}"
			      	    groups="purchase_heri.group_technicien_heri"
			      	 />
				<!--End bouton pour le workflow facturation tiers -->
		      	 
				</xpath>
				
				<xpath expr="//div[@name='button_box']//button[@name='action_view_invoice']" position="after">
				 	<button type="object"
	                            name="action_bci_lie_materiel_bon_etat"
	                            attrs="{'invisible': [('state', 'not in', ('materiel_bon_etat'))]}"
	                            class="oe_stat_button"
	                            icon="fa-check">
	                            <field name="bci_count"  widget="statinfo" string="Bon de cession interne" help="Bon de cession interne lié"/>
	                </button>
	                <button type="object"
	                            name="action_bci_lie_materiel_mauvais_etat"
	                            attrs="{'invisible': [('state', 'not in', ('materiel_mauvais_etat'))]}"
	                            class="oe_stat_button"
	                            icon="fa-close">
	                            <field name="bci_count"  widget="statinfo" string="Bon de cession interne" help="Bon de cession interne lié"/>
	                </button>
                </xpath>

			</field>
		</record>
		
		<record model="ir.ui.view" id="demande_retour_materiel_tree_view">
	        <field name="name">Demande de retour de matériels</field>
	        <field name="model">sale.order</field>
	        <field name="arch" type="xml">
	            <tree string="Demande de retour de matériels">
	                   <field name="message_needaction" invisible="1"/>
	                   <field name="name" string="Order Number"/>
	                   <field name="date_order"/>
	                   <field name="partner_id"/>
	                   <field name="user_id"/>
	                   <field name="amount_total" sum="Total Tax Included" widget="monetary"/>
	                   <field name="currency_id" invisible="1"/>
	                   <field name="invoice_status"/>
	                   <field name="state"/>
	               </tree>
	        </field>
     	</record>
		
		<record model="ir.actions.act_window" id="action_demande_retour_materiel">
	       	<field name="name">Demande de retour des materiels des entrepreneurs</field>
	       	<field name="res_model">sale.order</field>
			<field name="domain">[('facturation_type','=','facturation_mat_mauvais_etat')]</field>  	
			<field name="context">{'default_facturation_type': 'facturation_mat_mauvais_etat'}</field> 
	       	<field name="view_type">form</field>
	       	<field name="view_mode">tree,form</field>
	       	<field name="help" type="html">
	          	<p class="oe_view_nocontent_create">
	              Cliquer ici pour créer une demande de retour de matériels par l'entrepreneur.
	          	</p>
        	</field>
	   	</record>
	   	
	   	<record id="action_retour_materiel_tree_view" model="ir.actions.act_window.view">
            <field eval="1" name="sequence"/>
            <field name="view_mode">tree</field>
            <field name="view_id" ref="demande_retour_materiel_tree_view"/>
            <field name="act_window_id" ref="action_demande_retour_materiel"/>
        </record>

        <record id="action_retour_materiel_form_view" model="ir.actions.act_window.view">
            <field eval="2" name="sequence"/>
            <field name="view_mode">form</field>
            <field name="view_id" ref="demande_retour_materiel_form_view"/>
            <field name="act_window_id" ref="action_demande_retour_materiel"/>
		</record>
		<!-- Fin demande de retour de materiels par les entrepreneurs form -->
		
		<!-- Ouvrir BCI lie pour les materiels retournes lors d'une demande de retour de materiel par l'entrepreneur -->
		<record id="bci_retour_materiel_bon_etat_form" model="ir.ui.view">
            <field name="name">bon.cession.interne.form</field>
            <field name="model">stock.picking</field>
            <field name="mode">primary</field>
            <field name="inherit_id" ref="stock_heri.view_picking_form_advanced"/>
            <field name="arch" type="xml">
            	<field name="state" position="replace">
				    <field name="state" widget="statusbar" statusbar_visible="draft,attente_call_center,attente_logistique,attente_magasinier,done" />
				</field>
				<xpath expr="//field[@name='picking_type_id']" position="attributes">
				    <attribute name="domain">[('code','=','internal')]</attribute>
				</xpath> 
			    
 				<xpath expr="//button[@name='do_stock_transfer']" position="attributes">
					<attribute name="groups">purchase_heri.group_magasinier_heri</attribute>
					<attribute name="attrs">{'invisible': [('state','not in',('attente_magasinier'))]}</attribute>
				</xpath>
				<xpath expr="//button[@name='action_cancel']" position="attributes">
					<attribute name="attrs">{'invisible': [('state','in',('done','attente_logistique'))]}</attribute>
					<attribute name="groups">purchase_heri.group_logistique_heri</attribute>
				</xpath>
				<xpath expr="//header" position="inside">
				    <button name="aviser_call_center" string="Validation Call Center" class="oe_highlight" attrs="{'invisible': ['|',('state','not in',('draft')),('mouvement_type','not in',('bci'))]}" type="object" groups="purchase_heri.group_logistique_heri"/>
				    <button name="action_aviser_logistique_retour_mat" string="Validation logistique" class="oe_highlight" attrs="{'invisible': ['|',('state','not in',('attente_call_center')),('mouvement_type','not in',('bci'))]}" type="object" groups="purchase_heri.group_call_center_heri"/>
				    <button name="action_aviser_magasinier" string="Validation magasinier" class="oe_highlight" attrs="{'invisible': ['|',('state','not in',('attente_logistique')), ('mouvement_type','not in',('bci'))]}" type="object" groups="purchase_heri.group_logistique_heri"/>
				</xpath>
				
				<field name="location_dest_id" position="attributes">
                    <attribute name="domain">[('is_kiosque','=',False)]</attribute>
                    <attribute name="readonly">1</attribute>
				</field>
				<field name="location_id" position="attributes">
				    <attribute name="domain">[('is_kiosque','=',True)]</attribute>
				</field>
            </field>
        </record>
        
	    <!-- Ajout du champ qte_prevu dans move_lines -->
        
        <record id="bci_retour_mat_bon_tree" model="ir.ui.view">
            <field name="name">bon.cession.interne.tree</field>
            <field name="model">stock.picking</field>
            <field name="arch" type="xml">
                <tree string="Picking list" create="0">
                    <field name="name"/>
                    <field name="location_id"/>
                    <field name="location_dest_id"/>
                    <field name="partner_id"/>
                    <field name="date" invisible="1"/>
                    <field name="min_date"/>
                    <field name="origin"/>
                    <field name="group_id" invisible="1"/>
                    <field name="backorder_id"/>
                    <field name="state"/>
                    <field name="priority" invisible="1"/>
                    <field name="picking_type_id" invisible="1"/>
                </tree>
            </field>
        </record>
        <!-- Action ouvrir BCI lie pour les materiels retournes en bon etat lors d'une demande de retour de materiel par l'entrepreneur -->
        <record model="ir.actions.act_window" id="action_bci_retour_mat_bon_etat">
	       	<field name="name">Bon de cession interne</field>
	       	<field name="res_model">stock.picking</field>
			<field name="domain">[('sale_order_id','=',active_id)]</field>
			<field name="context">{'default_is_breq_stock': False, 'default_is_breq_id_sale': False, 'is_bci_sale_id': True, 'default_mouvement_type': 'bci', 'is_bon_etat': True}</field>
	       	<field name="view_type">form</field>
	       	<field name="view_mode">tree,form</field>
	   	</record>
        
	   	<record id="action_bci_retour_mat_bon_etat_lie_tree" model="ir.actions.act_window.view">
            <field eval="1" name="sequence"/>
            <field name="view_mode">tree</field>
            <field name="view_id" ref="bci_retour_mat_bon_tree"/>
            <field name="act_window_id" ref="action_bci_retour_mat_bon_etat"/>
        </record>
        
	   	<record id="action_bci_retour_mat_bon_etat_lie_form" model="ir.actions.act_window.view">
            <field eval="2" name="sequence"/>
            <field name="view_mode">form</field>
            <field name="view_id" ref="bci_retour_materiel_bon_etat_form"/>
            <field name="act_window_id" ref="action_bci_retour_mat_bon_etat"/>
		</record>
		<!-- End action ouvrir BCI lie pour les materiels retournes en bon etat lors d'une demande de retour de materiel par l'entrepreneur -->
		
		<record id="bci_retour_materiel_mauvais_etat_form" model="ir.ui.view">
            <field name="name">bon.cession.interne.form</field>
            <field name="model">stock.picking</field>
            <field name="mode">primary</field>
            <field name="inherit_id" ref="stock_heri.view_picking_form_advanced"/>
            <field name="arch" type="xml">
            	<field name="state" position="replace">
				    <field name="state" widget="statusbar" statusbar_visible="draft,attente_call_center,attente_finance,attente_magasinier,done" />
				</field>
				<xpath expr="//field[@name='picking_type_id']" position="attributes">
				    <attribute name="domain">[('code','=','internal')]</attribute>
				</xpath> 
			    
 				<xpath expr="//button[@name='do_stock_transfer']" position="attributes">
					<attribute name="groups">purchase_heri.group_magasinier_heri</attribute>
					<attribute name="attrs">{'invisible': [('state','not in',('attente_magasinier'))]}</attribute>
				</xpath>
				<xpath expr="//button[@name='action_cancel']" position="attributes">
					<attribute name="attrs">{'invisible': [('state','in',('done','attente_logistique'))]}</attribute>
					<attribute name="groups">purchase_heri.group_logistique_heri</attribute>
				</xpath>
				<xpath expr="//header" position="inside">
					<button name="aviser_call_center" string="Validation Call Center" class="oe_highlight" attrs="{'invisible': ['|',('state','not in',('draft')),('mouvement_type','not in',('bci'))]}" type="object" groups="purchase_heri.group_logistique_heri"/>
				    <button name="action_aviser_finance" string="Validation Finance" class="oe_highlight" attrs="{'invisible': ['|',('state','not in',('attente_call_center')),('mouvement_type','not in',('bci'))]}" type="object" groups="purchase_heri.group_call_center_heri"/>
				    <button name="action_aviser_magasinier" string="Validation magasinier" class="oe_highlight" attrs="{'invisible': ['|',('state','not in',('attente_finance')), ('mouvement_type','not in',('bci'))]}" type="object" groups="purchase_heri.group_finance_heri"/>
				 </xpath>
				
				<field name="location_dest_id" position="attributes">
                    <attribute name="domain">[('is_kiosque','=',False)]</attribute>
                    <attribute name="readonly">1</attribute>
				</field>
				<field name="location_id" position="attributes">
				    <attribute name="domain">[('is_kiosque','=',True)]</attribute>
				</field>
				<xpath expr="//div[@name='button_box']/button[@name='action_see_move_scrap']" position="after">
					<button type="object"
	                            name="action_breq_stock_lie_materiel_mauvais_etat"
	                            attrs="{'invisible': ['|',('state', 'not in', ('done'))]}"
	                            class="oe_stat_button"
	                            icon="fa-folder">
	                            <field name="breq_stock_count"  widget="statinfo" string="Budget Request Stock" help="Budget Request Stock lié"/>
	                </button>
 				</xpath>
            </field>
        </record>
		
		<!-- Action ouvrir BCI lie pour les materiels retournes en mauvais etat lors d'une demande de retour de materiel par l'entrepreneur -->
        <record model="ir.actions.act_window" id="action_bci_retour_mat_mauvais_etat">
	       	<field name="name">Bon de cession interne</field>
	       	<field name="res_model">stock.picking</field>
			<field name="domain">[('sale_order_id','=',active_id)]</field>
			<field name="context">{'default_is_breq_stock': False, 'default_is_breq_id_sale': False, 'is_bci_sale_id': True, 'default_mouvement_type': 'bci', 'is_bon_etat': False}</field>
	       	<field name="view_type">form</field>
	       	<field name="view_mode">tree,form</field>
	   	</record>
        
	   	<record id="action_bci_retour_mat_mauvais_etat_lie_tree" model="ir.actions.act_window.view">
            <field eval="1" name="sequence"/>
            <field name="view_mode">tree</field>
            <field name="view_id" ref="bci_retour_mat_bon_tree"/>
            <field name="act_window_id" ref="action_bci_retour_mat_mauvais_etat"/>
        </record>
        
	   	<record id="action_bci_retour_mat_mauvais_etat_lie_form" model="ir.actions.act_window.view">
            <field eval="2" name="sequence"/>
            <field name="view_mode">form</field>
            <field name="view_id" ref="bci_retour_materiel_mauvais_etat_form"/>
            <field name="act_window_id" ref="action_bci_retour_mat_mauvais_etat"/>
		</record>
		<!-- End action ouvrir BCI lie pour les materiels retournes en mauvais etat lors d'une demande de retour de materiel par l'entrepreneur -->
		<!-- Ouvrir BCI lie pour les materiels retournes lors d'une demande de retour de materiel par l'entrepreneur -->
		
		<!-- Budget request stock from -->		
		<record id="budget_request_stock_retour_mat_mauvais_etat_form" model="ir.ui.view">
            <field name="name">Budget Request Stock</field>
            <field name="model">purchase.order</field>
            <field name="mode">primary</field>
            <field name="inherit_id" ref="stock_heri.budget_request_stock_form"/>
            <field name="arch" type="xml">
            	<field name="state" position="replace">
				    <field name="state" widget="statusbar" statusbar_visible="nouveau,bs" />
				</field>
            	<xpath expr="//button[@name='creer_bs']" position="replace">
            		<button 
	                    string="Créer bon de sortie"
	                    type="object" 
	                    name="creer_bs"
	                    class="oe_highlight" 
	                    attrs="{'invisible': ['|',('state', 'not in', ('nouveau')), '|', ('is_breq_stock', '=', False), ('is_breq_id_sale', '=', False)]}"
	                    groups="purchase_heri.group_magasinier_heri"
                    />
            	</xpath>
				<xpath expr="//div[@name='button_box']//button[@name='action_bs_lie']" position="before">
				 	<button type="object"
		 					name="action_breq_stock_lie_facture"
		                    attrs="{'invisible': ['|',('state', 'not in', ('bs'))]}"
		                    class="oe_stat_button"
		                    icon="fa-pencil-square-o">
		                    <field name="breq_facture_stock_count"  widget="statinfo" string="Facture" help="Facture du Budget Request Stock"/>
		                    <field name="breq_facture_stock_ids" invisible="1"/>
	                </button>
                </xpath>
            </field>
        </record>
		<!-- Fin Budget request stock form -->	
				
		<!-- Action ouvrir Breq stock lie pour les materiels retournes en mauvais etat lors d'une demande de retour de materiel par l'entrepreneur -->
		<!-- Budget request stock tree view -->			
		<record model="ir.ui.view" id="budget_request_stock_materiel_mauvais_etat_tree">
	        <field name="name">Budget request stock</field>
	        <field name="model">purchase.order</field>
	        <field name="arch" type="xml">
	            <tree string="Budget Request" decoration-bf="message_unread==True" decoration-muted="state=='cancel'" create="0">
	            	<field name="message_unread" invisible="1"/>
                    <field name="name" string="Reference"/>
                    <field name="employee_id"/>
                    <field name="department_id"/>
	                <field name="partner_id" invisible="1"/>
                    <field name="company_id" groups="base.group_multi_company" options="{'no_create': True}"/>
                    <field name="date_planned" invisible="context.get('quotation_only', False)"/>
                    <field name="amount_untaxed" sum="Total Untaxed amount" string="Untaxed" widget="monetary"/>
                    <field name="amount_total" sum="Total amount" widget="monetary" invisible="1"/>
                    <field name="currency_id" invisible="1"/>
                    <field name="change_state_date"/>
                    <field name="statut_budget"/>
                    <field name="state" string="Etat BReq"/>
                    <field name="statut_bex" invisible="1"/>
                    <field name="is_creator" invisible="1"/>
                    <field name="invoice_status" invisible="not context.get('show_purchase', False)"/>
	            </tree>
	        </field>
	    </record>
		<!-- Fin Budget request stock tree -->	
				
        <record model="ir.actions.act_window" id="action_budget_request_stock_lie">
	       	<field name="name">Budget Request Stock</field>
	       	<field name="res_model">purchase.order</field>
			<field name="domain">[('picking_bci_id','=',active_id)]</field>
			<field name="view_type">form</field>
	       	<field name="view_mode">tree,form</field>
	   	</record>
        
	   	<record id="action_breq_stock_lie_materiel_mauvais_etat_tree" model="ir.actions.act_window.view">
            <field eval="1" name="sequence"/>
            <field name="view_mode">tree</field>
            <field name="view_id" ref="budget_request_stock_materiel_mauvais_etat_tree"/>
            <field name="act_window_id" ref="action_budget_request_stock_lie"/>
        </record>
        
	   	<record id="action_breq_stock_lie_materiel_mauvais_etat_form" model="ir.actions.act_window.view">
            <field eval="2" name="sequence"/>
            <field name="view_mode">form</field>
            <field name="view_id" ref="budget_request_stock_retour_mat_mauvais_etat_form"/>
            <field name="act_window_id" ref="action_budget_request_stock_lie"/>
		</record>
		<!-- End action ouvrir Breq stock lie pour les materiels retournes en mauvais etat lors d'une demande de retour de materiel par l'entrepreneur -->
		
		<menuitem 
		    id="menu_retour_materiel_entrepreneur" 
		    name="Demande de retour de matériels par l'entrepreneur" 
		    parent="sales_team.menu_sales" 
		    action="action_demande_retour_materiel" 
		    sequence="3"/>
	</data>
</odoo>